odoo.define("web.approval_form_view",function(require){var t=require("web.FormView"),n=require("web.data"),o=require("web.DataModel"),r=require("web.session"),s=require("web.Dialog"),i=require("web.core"),a=require("web.View"),l=require("web.FilterMenu"),d=i.qweb,c=require("web.ActionManager"),p=require("web.data_manager");c.include({ir_actions_act_window_close:function(e,t){return this.dialog||t.on_close(),this.dialog_stop(e),$.when()}}),$.extend(a.prototype.events,{"click button.btn-approval":function(e){e.preventDefault(),this.do_approval($(e.currentTarget).data("instance_node_id"))},"click button.btn-increase":function(e){e.preventDefault();var t=this;this.do_action({name:"加签",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"approval.increase.wizard",views:[[!1,"form"]],target:"new",context:{instance_node_id:$(e.currentTarget).data("instance_node_id")}},{on_close:function(e){e&&e.state&&t.get_approval_flow()}})},"click button.btn-delete-increase":function(e){e.preventDefault();var t=this;s.confirm(this,"确认要删除该加签节点吗？",{confirm_callback:function(){t.delete_increase_node($(e.currentTarget).data("instance_node_id"))}})},"click button.btn-turn-to":function(e){e.preventDefault();var t=this;this.do_action({name:"转签",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"approval.turn.to.wizard",views:[[!1,"form"]],target:"new",context:{instance_node_id:$(e.currentTarget).data("instance_node_id")}},{on_close:function(e){e&&e.state&&t.get_approval_flow()}})},"click button.btn-delete-turn-to":function(e){e.preventDefault();var t=this;s.confirm(this,"确认要删除该转签节点吗？",{confirm_callback:function(){t.delete_turn_to_node($(e.currentTarget).data("instance_node_id"))}})},"click button.btn-edit-turn-to":function(e){e.preventDefault();var t=this;this.do_action({name:"编辑转签",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"approval.edit.turn.to.wizard",views:[[!1,"form"]],target:"new",context:{instance_node_id:$(e.currentTarget).data("instance_node_id")}},{on_close:function(e){e&&e.state&&t.get_approval_flow()}})},"click button.btn-edit-approval":function(e){e.preventDefault(),this.do_edit_approval($(e.currentTarget).data("approval_id"))}}),t.include({do_execute_action:function(e,t,i,o){if(["commit_approval","pause_approval","resume_approval"].includes(e.type))return this.control_approval(i,e.type);if("cancel_approval"===e.type)return this.cancel_approval(i);if("approval"===e.type){var n=$(".btn-do-approval").data("instance_node_id");if(""===n)return;return this.do_approval(n)}return this._super.apply(this,arguments)},cancel_approval:function(e){var t=new $.Deferred,i=this;return s.confirm(this,"确认要取消审批吗？",{confirm_callback:function(){t.resolve(),i.control_approval(e,"cancel_approval")},cancel_callback:function(){t.resolve()}}),t},do_push_state:function(e){this._super(e),this.init_config_condition();var t=$(".btn-commit-approval",this.$el);if(0!==t.length){if($(".approval-wizard",this.$el).remove(),void 0===this.datarecord.id)return t.addClass("o_form_invisible"),$(".btn-pause-approval",this.$el).addClass("o_form_invisible"),$(".btn-cancel-approval",this.$el).addClass("o_form_invisible"),$(".btn-resume-approval",this.$el).addClass("o_form_invisible"),void $(".btn-do-approval",this.$el).addClass("o_form_invisible");this.get_approval_flow()}},do_approval:function(e){var t=this;return this.do_action({name:"审批",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"approval.wizard",views:[[!1,"form"]],target:"new",context:{model:this.model,res_id:this.datarecord.id,instance_node_id:e}},{on_close:function(e){e&&e.state&&t.get_approval_flow()}})},do_edit_approval:function(e){var t=this;return this.do_action({name:"编辑审批",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"edit.approval.wizard",views:[[!1,"form"]],target:"new",context:{model:this.model,res_id:this.datarecord.id,approval_id:e}},{on_close:function(e){e&&e.state&&t.get_approval_flow()}})},control_approval:function(e,t){var i=this;return r.rpc("/web/dataset/control_approval",{model:this.model,res_id:e,action_type:t}).then(function(){i.get_approval_flow()})},toggle_approval_buttons:function(e,t,i){var o=$(".btn-commit-approval",this.$el),n=$(".btn-pause-approval",this.$el),a=$(".btn-cancel-approval",this.$el),r=$(".btn-resume-approval",this.$el);e?o.removeClass("o_form_invisible"):o.addClass("o_form_invisible"),t?""===i?(n.addClass("o_form_invisible"),a.addClass("o_form_invisible"),r.addClass("o_form_invisible")):"active"===i?(n.removeClass("o_form_invisible"),a.removeClass("o_form_invisible"),r.addClass("o_form_invisible")):"complete"===i?(n.addClass("o_form_invisible"),a.addClass("o_form_invisible"),r.addClass("o_form_invisible")):"cancel"===i?(n.addClass("o_form_invisible"),a.addClass("o_form_invisible"),r.addClass("o_form_invisible")):(n.addClass("o_form_invisible"),a.removeClass("o_form_invisible"),r.removeClass("o_form_invisible")):(n.addClass("o_form_invisible"),a.addClass("o_form_invisible"),r.addClass("o_form_invisible"))},get_approval_flow:function(){var n=this.$el,a=this;r.rpc("/web/dataset/get_approval_flow",{model:this.model,res_id:this.datarecord.id}).then(function(e){a.toggle_approval_buttons(e.show_commit_btn,e.show_buttons,e.approval_state);var t=$(".btn-do-approval",a.$el);if(t.removeData("instance_node_id"),t.addClass("o_form_invisible"),0<e.instance_nodes.length){$(".approval-wizard",a.$el).remove();var i=$(d.render("ApprovalTemplate",{instance_nodes:e.instance_nodes,approval_state:e.approval_state}));if(n.hasClass("o_form_nosheet"))n.append(i);else{var o=$(".oe_chatter",n);0<o.length?o.before(i):n.append(i)}e.instance_nodes.forEach(function(e){e.can_approval&&(t.removeClass("o_form_invisible"),t.data("instance_node_id",e.id))})}})},delete_increase_node:function(e){var t=this;new n.DataSet(this,"approval.flow.instance.node").call("delete_increase_node",[e]).done(function(e){t.get_approval_flow()})},delete_turn_to_node:function(e){var t=this;new n.DataSet(this,"approval.flow.instance.node").call("delete_turn_to_node",[e]).done(function(e){t.get_approval_flow()})}}),t.include({init:function(){this._super.apply(this,arguments),this.bind_trigger_event()},start:function(){var e=this._super();return"approval.flow"===this.model&&(this.filter_menu=new l(this,[])),e},bind_trigger_event:function(){"approval.flow"===this.model&&(this.ir_models={},this.on("to_edit_mode",this,this.change_to_edit_mode),this.on("on_button_cancel",this,this.exit_edit_mode),this.on("to_view_mode",this,this.exit_edit_mode),this.on("load_record",this,function(){"create"===this.get("actual_mode")?this.change_to_edit_mode():this.exit_edit_mode()}),this.on("field_changed:model_id",this,this.model_id_changed))},get_ir_model:function(t,e){if(this.ir_models[e])t.resolve();else{var i=this;new o("ir.model").call("read",[[i.fields.model_id.get_value()],["model"]]).then(function(e){i.ir_models[e[0].id]=e[0].model,t.resolve()})}return t},model_id_changed:function(){var i=this;this.fields.condition.set_value(""),this.fields.approval_can_run.set_value(""),this.fields.approval_cannot_run.set_value(""),_.invoke(this.filter_menu.propositions,"destroy"),this.filter_menu.propositions=[];var o=this.fields.model_id.get_value();if(o){var e=new $.Deferred;$.when(i.get_ir_model(e,o)).done(function(){var e=i.ir_models[o],t=new n.DataSet(i,e);p.load_fields(t).then(function(e){var i={id:{string:"ID",type:"id",searchable:!0}};return _.each(e,function(e,t){!1!==e.selectable&&"id"!==t&&(i[t]=e)}),i})})}},change_to_edit_mode:function(){$(".config_condition",this.$el).removeClass("o_form_invisible"),$(".config_approval_can_run",this.$el).removeClass("o_form_invisible"),$(".config_approval_cannot_run",this.$el).removeClass("o_form_invisible")},exit_edit_mode:function(){$(".config_condition",this.$el).addClass("o_form_invisible"),$(".config_approval_can_run",this.$el).addClass("o_form_invisible"),$(".config_approval_cannot_run",this.$el).addClass("o_form_invisible")},init_config_condition:function(){if("approval.flow"===this.model){var e=$(".config_condition");if(0===e.length)return;0===e.children().length&&(this.filter_menu.appendTo(e),$(".caret",e).remove(),$("button.o_dropdown_toggler_btn",e).addClass("oe_link"),this.override_get_fields(),this.redelegate_events())}},redelegate_events:function(){this.filter_menu.undelegateEvents();var r=this,e={"click .o_add_filter":function(e){e.preventDefault(),r.fields.model_id.get_value()?r.filter_menu.toggle_custom_filter_menu():s.alert(r,"请选择模型！")},"click li":function(e){e.preventDefault(),e.stopImmediatePropagation()},"hidden.bs.dropdown":function(){r.filter_menu.toggle_custom_filter_menu(!1)},"click .o_add_condition":"append_proposition","click .o_apply_filter":function(e){var t=_.map(this.propositions,function(e){var t=e.attrs.selected,i=e.$(".o_searchview_extended_prop_op")[0],o=i.options[i.selectedIndex];return e.value.get_domain(t,o)});if(0!==t.length){for(var i=0,o=t.length-1;i<o;i++)t.unshift("|");var n=[];for(i=0,o=t.length;i<o;i++)t[i]instanceof Array?n.push(t[i][0]):n.push(t[i]);var a=JSON.parse(r.fields.condition.get_value()||"[]");a=a.concat(n),r.fields.condition.set_value(JSON.stringify(a)),_.invoke(this.propositions,"destroy"),this.propositions=[],this.append_proposition(),this.toggle_custom_filter_menu(!1)}}};for(var t in e){var i=this.filter_menu.proxy(e[t]),o=/^(\S+)(\s+(.*))?$/.exec(t),n=o[1],a=o[3];n+=".widget_events",a?this.filter_menu.$el.on(n,a,i):this.filter_menu.$el.on(n,i)}},override_get_fields:function(){var o=this;this.filter_menu.get_fields=function(){var e=o.fields.model_id.get_value(),t=o.ir_models[e],i=new n.DataSet(o,t);return this._fields_def=p.load_fields(i).then(function(e){var i={id:{string:"ID",type:"id",searchable:!0}};return _.each(e,function(e,t){!1!==e.selectable&&"id"!==t&&(i[t]=e)}),i}),this._fields_def}}})});