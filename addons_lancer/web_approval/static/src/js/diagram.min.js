odoo.define("web_approval.DiagramView",function(require){var e=require("web.View"),n=require("web.core"),i=require("web.Pager"),r=require("web.Dialog"),s=require("web.data"),o=n.qweb,a=e.extend({display_name:"流程图",icon:"fa-code-fork",multi_record:!1,searchable:!1,template:"ApprovalDiagramView",start:function(){return this.instance=jsPlumb.getInstance({ConnectionOverlays:[["Arrow",{location:1,id:"arrow",width:12,length:12}],["Label",{id:"label",cssClass:"aLabel"}]],Container:"diagramContainer"}),this._super()},destroy:function(){return this.instance=null,this.$el.empty(),this._super.apply(this,arguments)},do_show:function(){return this.do_push_state({}),$.when(this._super(),this.reload())},reload:function(){return this.dataset.read_index([],{}).then(this.on_diagram_loaded).then(this.proxy("update_pager"))},render_pager:function(t){var e=this;this.pager=new i(this,this.dataset.ids.length,this.dataset.index+1,1),this.pager.appendTo(t||this.options.$pager),this.pager.on("pager_changed",this,function(t){e.pager.disable(),e.dataset.index=t.current_min-1,$.when(this.reload()).then(function(){e.pager.enable()})})},render_buttons:function(t){var e=this;this.$buttons=$(o.render("ApprovalDiagramView.buttons",{widget:this})),this.$buttons.on("click",".o_diagram_new_button",function(){e.add_node()}),this.$buttons.appendTo(t)},update_pager:function(){this.pager&&this.pager.update_state({size:this.dataset.ids.length,current_min:this.dataset.index+1})},on_diagram_loaded:function(t){this.set({title:t.id?t.name:"新建节点"});var e=t.id;e?(this.id=e,this.get_diagram_info(),this.do_push_state({id:e})):this.do_push_state({})},get_diagram_info:function(){var e=this,t={flow_id:this.id};return this.rpc("/web_approval/get_approval_info",t).done(function(t){e.actions=t.actions,e.paths=t.paths,e.draw_diagram()})}});a.include({draw_diagram:function(){this.instance.reset(),this.$el.empty(),this.draw_nodes(),this.draw_connector(),this.add_connection_menu(),this.add_node_menu()},operate_connection_node:function(e,t,n){var i,o,a=this;if("node"===n){var d=this.paths.filter(function(t){return t.node_id===parseInt(e)})[0];if(d.is_start||d.is_end)return void r.alert(this,"开始节点和结束节点不能删除或编辑！");"delete"===t&&(i={confirm_callback:function(){new s.DataSet(this,"approval.flow.node").unlink([parseInt(e,10)]).done(function(){a.delete_node_done(e)})}},r.confirm(this,"确认要删除该节点吗？",i)),"edit"===t&&(o={name:"编辑节点",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"edit.node.wizard",views:[[!1,"form"]],target:"new",context:{node_id:parseInt(e),type:"edit"}},this.do_action(o,{on_close:function(t){a.edit_node_done(t)}}))}else if("delete"===t&&(i={confirm_callback:function(){new s.DataSet(this,"approval.flow.node.action").unlink([parseInt(e,10)]).done(function(){a.delete_connection_done(e)})}},r.confirm(this,"确认要删除该动作吗？",i)),"edit"===t){if("refuse"===this.actions.filter(function(t){return t.id===parseInt(e)})[0].action_type)return;o={name:"编辑动作",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"edit.node.action.wizard",views:[[!1,"form"]],target:"new",context:{node_action_id:parseInt(e)}},this.do_action(o,{on_close:function(t){a.edit_connection_done(t)}})}},add_node_menu:function(){var e=this;$.contextMenu({selector:"#diagramContainer .item",callback:function(t){e.operate_connection_node($(this).attr("id").replace("node_",""),t,"node")},items:{edit:{name:"编辑",icon:"edit"},delete:{name:"删除",icon:"delete"}}})},add_connection_menu:function(){var e=this;$.contextMenu({selector:".jtk-connector",callback:function(t){e.operate_connection_node($(this).data("action_id"),t,"contention")},items:{edit:{name:"编辑",icon:"edit"},delete:{name:"删除",icon:"delete"}}})},add_node:function(){var t={name:"添加节点",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"edit.node.wizard",views:[[!1,"form"]],target:"new",context:{flow_id:this.id,type:"add"}},e=this;this.do_action(t,{on_close:function(t){e.add_node_done(t)}})},add_node_done:function(t){var e=t.action;if(void 0!==e){var n=this.paths.filter(function(t){return t.is_end})[0],i=n.serial_num;n.serial_num++,this.paths.splice(this.paths.length-1,0,{node_id:e.id,serial_num:i,node_name:e.name,is_start:!1,is_end:!1}),this.draw_diagram()}},edit_node_done:function(t){var e=t.action;void 0!==e&&$("#node_"+e.id).text(e.name)},delete_node_done:function(t){var e="node_"+t,n=this;this.instance.getConnections().forEach(function(t){t.sourceId!==e&&t.targetId!==e||n.instance.deleteConnection(t)});for(var i=0,o=this.paths.length;i<o;i++)if(this.paths[i].node_id===parseInt(t,10)){this.paths.splice(i,1);break}$("#"+e).remove(),this.draw_diagram()},on_connection:function(t){var e=parseInt(t.sourceId.replace("node_","")),n=parseInt(t.targetId.replace("node_",""));if(e!==n){var i={},o={};if(this.paths.forEach(function(t){t.node_id===e&&(i=t),t.node_id===n&&(o=t)}),i.is_start&&o.is_end||i.is_end&&o.is_start)r.alert(this,"开始节点和结束节点不能建立连接！");else{var a={name:"添加动作",type:"ir.actions.act_window",view_type:"form",view_mode:"form",res_model:"add.node.action.wizard",views:[[!1,"form"]],target:"new",context:{source_node_id:e,target_node_id:n,source_serial_num:i.serial_num,target_serial_num:o.serial_num,flow_id:this.id}},d=this;this.do_action(a,{on_close:function(t){d.add_connection_done(t)}})}}},add_connection_done:function(t){var e=t.action;void 0!==e&&(this.actions.push(e),"accept"===e.action_type?this.draw_accept_connection(e):this.draw_refuse_connection(e))},edit_connection_done:function(t){var n=t.action;void 0!==n&&(this.actions.forEach(function(t){t.id===n.id&&(t.condition=n.condition)}),this.instance.getConnections().forEach(function(t){if(t.getData().action_id===n.id){var e=$(t.getOverlay("label").getElement());e.text(n.condition),""===n.condition?e.hide():e.show()}}))},delete_connection_done:function(e){var n=this;this.instance.getConnections().forEach(function(t){t.getData().action_id===parseInt(e)&&n.instance.deleteConnection(t)})},draw_connector:function(){var n=this;this.instance.bind("connection",function(t){var e=t.connection.getData();void 0!==e.action_id?(e.condition?t.connection.getOverlay("label").setLabel(e.condition):$(t.connection.getOverlay("label").getElement()).hide(),$(t.connection.canvas).data("action_id",e.action_id)):(n.instance.deleteConnection(t.connection),n.on_connection(t))}),jsPlumb.getSelector("#diagramContainer .item").forEach(function(t){n.instance.draggable(t),n.instance.makeSource(t,{filter:".ep"}),n.instance.makeTarget(t)}),this.actions.forEach(function(t){"accept"===t.action_type?n.draw_accept_connection(t):n.draw_refuse_connection(t)})},draw_accept_connection:function(t){this.instance.connect({source:"node_"+t.source_node_id,target:"node_"+t.target_node_id,anchors:["BottomCenter","TopCenter"],paintStyle:{strokeWidth:3,stroke:"#428bca"},connector:["Flowchart",{stub:[10,20],gap:6,cornerRadius:5,alwaysRespectStubs:!0}],hoverPaintStyle:{stroke:"#428bca",strokeWidth:6},endpointStyle:{fill:"#428bca"},endpoint:["Dot",{radius:6}],data:{condition:t.condition,action_id:t.id}})},draw_refuse_connection:function(e){var n;this.paths.forEach(function(t){t.node_id===e.source_node_id&&(n=t.is_left)}),this.instance.connect({source:"node_"+e.source_node_id,target:"node_"+e.target_node_id,anchors:n?["LeftMiddle","LeftMiddle"]:["RightMiddle","RightMiddle"],paintStyle:{strokeWidth:3,stroke:"#ff0000"},connector:["Flowchart",{stub:[10,20],gap:6,cornerRadius:5,alwaysRespectStubs:!0}],hoverPaintStyle:{stroke:"#ff0000",strokeWidth:6},endpointStyle:{fill:"#ff0000"},endpoint:["Dot",{radius:6}],data:{condition:e.condition,action_id:e.id}})},draw_nodes:function(){var a=30,n=this.$el,d=parseInt(n.css("width")),r=400;d<r&&(r=d),this.paths.forEach(function(t){var e=$(o.render("ApprovalDiagramView.node",{path:t}));e.appendTo(n),t.node_width=parseInt(e.css("width")),t.node_el=e});var s=0;this.paths.forEach(function(t){var e,n,i,o;t.is_left=!1,t.is_right=!1,t.is_start||t.is_end?n=(d-t.node_width)/2:(s%2==0?(t.is_left=!0,o=Math.floor(50*Math.random()),n=(Math.max(d,r)-r)/2+o):(t.is_right=!0,o=Math.floor(50*Math.random()),i=(Math.max(d,r)-r)/2+o,n=Math.max(d,r)-i-t.node_width),s++),e=t.is_start?a:a+=Math.floor(30*Math.random()+100),t.node_el.css({top:e+"px",left:n+"px"})})}}),n.view_registry.add("approval_diagram",a)});